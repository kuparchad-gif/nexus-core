#!/usr/bin/env python3
# deploy_crown.py — FINAL WORKING VERSION (Nov 19 2025)
import modal
import sys

# Mount the whole project so every file is visible
project_mount = modal.Mount.from_local_dir(
    local_path=r"C:\project-root\10_env\aethereal_nexus",   # ← your real path
    remote_path="/root/project"
)

app = modal.App("nexus-core-modalDB7", mounts=[project_mount])

# Tell Python where to look
sys.path.insert(0, "/root/project/core")   # ← core subfolder where everything lives

image = (
    modal.Image.debian_slim()
    .apt_install("curl", "tar", "ca-certificates", "espeak", "espeak-ng")
    .run_commands([
        "curl -L https://github.com/nats-io/nats-server/releases/download/v2.10.11/nats-server-v2.10.11-linux-amd64.tar.gz -o nats-server.tar.gz",
        "tar -xvzf nats-server.tar.gz",
        "cp nats-server-v2.10.11-linux-amd64/nats-server /usr/local/bin/",
        "rm -rf nats-server.tar.gz nats-server-v2.10.11-linux-amd64"
    ])
    .pip_install([
        "nats-py", "numpy", "scipy", "sympy", "pandas", "matplotlib", "seaborn",
        "fastapi", "uvicorn", "flask", "flask-cors", "pydantic", "requests", "aiohttp",
        "qdrant-client", "redis", "sqlalchemy", "psycopg2-binary", "pymongo",
        "psutil", "cryptography", "pyttsx3", "pillow", "opencv-python",
        "scikit-learn", "torch", "transformers", "tensorflow", "keras",
        "aiofiles", "websockets", "httpx",
        "pytz", "python-dateutil", "arrow",
        "bcrypt", "pyjwt", "oauthlib",
        "pyyaml", "toml", "xmltodict", "openpyxl",
        "pytest", "black", "flake8", "mypy",
        "click", "rich", "tqdm", "loguru", "colorama", "beautifulsoup4",
        "qiskit", "cirq", "pennylane", "langchain", "openai"
    ])
)

@app.function(image=image, keep_warm=1, timeout=0, cpu=4, memory=16384)
@modal.asgi_app()
def crown():
    # Lazy imports inside the function = Modal can’t mess with us
    from nexus_unified_system import NexusUnifiedSystem
    from nexus_os_coupler import galactic_nexus_coupler   # ← correct name

    print("✅ Crown function started — Oz is waking up")

    system = NexusUnifiedSystem()
    import asyncio
    asyncio.run(system.initialize_system())

    # This is the real Oz FastAPI app
    return galactic_nexus_coupler()