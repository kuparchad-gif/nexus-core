version: '3.9'
services:
  api:
    build: ../server
    environment:
      PORT: 4000
      ROUTER_AUTH_MODE: 'both'
      ROUTER_API_KEYS: 'alpha123,beta456'
      ORIGIN_ALLOWLIST: 'http://localhost:8080,http://localhost:5173'
      RELAY_ADAPTER: 'fs'
      GABRIEL_UDP_PORT: 9400
      GABRIEL_TCP_PORT: 9500
    ports:
      - "4000:4000"
      - "9400:9400/udp"
      - "9500:9500"
  ui:
    image: node:20-slim
    working_dir: /srv/ui
    volumes:
      - ../client:/srv/ui
    command: bash -lc "npm i && npm run build && cd dist && python -m http.server 5173"
    ports:
      - "5173:5173"
  nginx:
    image: nginx:1.27-alpine
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - api
      - ui
