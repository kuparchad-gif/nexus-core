version: "3.9"
services:
  qdrant:
    image: qdrant/qdrant:latest
    ports: ["6333:6333"]
    volumes: ["./qdrant_storage:/qdrant/storage"]
    restart: unless-stopped

  api:
    image: python:3.12-slim
    working_dir: /app
    command: bash -lc "pip install --no-cache-dir -r requirements.txt && uvicorn services.api.main:app --host 0.0.0.0 --port 8080"
    volumes: [".:/app"]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - COLLECTION_NAME=${COLLECTION_NAME:-nexus_qna}
      - EMBEDDINGS_PROVIDER=${EMBEDDINGS_PROVIDER:-local}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-384}
      - VERIFIER_URL=${VERIFIER_URL:-http://worker:8090/verify}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
    ports: ["8080:8080"]
    depends_on: [qdrant, worker]
    restart: unless-stopped

  worker:
    image: python:3.12-slim
    working_dir: /app
    command: bash -lc "pip install --no-cache-dir -r requirements.txt && python -m services.worker.worker"
    volumes: [".:/app"]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - COLLECTION_NAME=${COLLECTION_NAME:-nexus_qna}
      - EMBEDDINGS_PROVIDER=${EMBEDDINGS_PROVIDER:-local}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-384}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - BING_SEARCH_V7_SUBSCRIPTION_KEY=${BING_SEARCH_V7_SUBSCRIPTION_KEY}
      - VERIFY_MIN_SOURCES=${VERIFY_MIN_SOURCES:-2}
      - VERIFY_MIN_COVERAGE=${VERIFY_MIN_COVERAGE:-0.7}
      - VERIFY_MAX_AGE_DAYS=${VERIFY_MAX_AGE_DAYS:-180}
      - DOMAIN_ALLOWLIST=${DOMAIN_ALLOWLIST:-docs.,developer.,learn.,support.,help.,.gov,.edu,readthedocs,man.,kubernetes.io,nginx.org,openssl.org,linux.die.net,mdn.,cloud.google.com,learn.microsoft.com,docs.aws.amazon.com,doc.rust-lang.org,python.org,fastapi.tiangolo.com}
      - VERIFIER_BACKEND=${VERIFIER_BACKEND:-mnli}
      - MNLI_MODEL_NAME=${MNLI_MODEL_NAME:-roberta-large-mnli}
    ports: ["8090:8090"]
    depends_on: [qdrant]
    restart: unless-stopped
